{# templates/calibration/calibrate.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Calibrate Device{% endblock %}

{% block body %}
<div class="min-h-screen text-white bg-gray-900">

  <!-- Header -->
  <header class="sticky top-0 z-50 px-4 py-3 bg-gray-800 border-b border-gray-700 shadow-md">
    <div class="flex items-center justify-between">
      <h1 class="text-xl font-semibold text-white">Calibrate Device</h1>
      <a href="{{ path('app_dashboard') }}" class="text-sm text-sky-400 hover:text-sky-300">
        ‚Üê Dashboard
      </a>
    </div>
    <div class="mt-1 text-sm text-gray-400">
      {{ device.serialNumber ?: ('AS25-' ~ device.id) }}
      {% if device.macAddress %}
        <span class="ml-2 font-mono text-xs">{{ device.macAddress|upper }}</span>
      {% endif %}
    </div>
  </header>

  <main class="pb-20">

    <!-- Flash Messages -->
    {% for type, messages in app.flashes %}
      {% for message in messages %}
        <div class="mx-4 mt-4 p-3 rounded-lg border-l-4 {% if type == 'success' %}bg-green-900/50 border-green-500 text-green-100{% elseif type == 'warning' %}bg-yellow-900/50 border-yellow-500 text-yellow-100{% else %}bg-red-900/50 border-red-500 text-red-100{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endfor %}

    <!-- Channel Tabs -->
    <div class="sticky top-[60px] z-40 bg-gray-800 border-b border-gray-700">
      <div class="flex">
        {% for channelIndex in 1..2 %}
          {% set channel = device.getChannel(channelIndex) %}
          <button
            type="button"
            class="channel-tab flex-1 px-4 py-3 text-sm font-medium transition-colors border-b-2"
            data-channel="{{ channelIndex }}"
            onclick="switchChannel({{ channelIndex }})"
          >
            <div class="channel-tab-label">{{ channel ? channel.displayLabel : ('Channel ' ~ channelIndex) }}</div>
            {% if channel and not channel.enabled %}
              <div class="text-xs text-gray-400 mt-0.5">Disabled</div>
            {% endif %}
          </button>
        {% endfor %}
      </div>
    </div>

    <!-- Channel 1 Content -->
    <div id="channel-1-content" class="channel-content">

      <!-- Live Readings Card -->
      <section class="m-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Live Readings - Channel 1</h2>
          <button
            type="button"
            onclick="refreshData(1)"
            class="px-3 py-1 text-xs font-medium bg-sky-600 hover:bg-sky-700 rounded transition-colors"
          >
            üîÑ Refresh
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <div class="text-gray-400 text-xs mb-1">Air Pressure</div>
            <div id="ch1-air-pressure" class="font-semibold text-green-400">-- psi</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs mb-1">Weight (Calc)</div>
            <div id="ch1-weight" class="font-semibold text-yellow-400">-- lbs</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs mb-1">Ambient Pressure</div>
            <div id="ch1-ambient-pressure" class="font-semibold text-green-400">-- psi</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs mb-1">Temperature</div>
            <div id="ch1-temperature" class="font-semibold text-green-400">--¬∞F</div>
          </div>
        </div>

        <div class="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
          Last updated: <span id="ch1-timestamp">--</span>
        </div>
      </section>

      <!-- Calibration Form Card -->
      <section class="m-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
        <h2 class="text-lg font-semibold mb-3">Add Calibration Point</h2>
        <p class="text-sm text-gray-400 mb-4">Place a known weight on your scale, then enter it below.</p>

        {{ form_start(form, { attr: { class: 'space-y-4', id: 'calibration-form' } }) }}

          <!-- Hidden channel selection - set via JS -->
          {{ form_widget(form.deviceChannel, {
            attr: {
              id: 'form-device-channel',
              class: 'hidden'
            }
          }) }}

          <!-- Scale Weight Input -->
          <div>
            {{ form_label(form.scaleWeight, 'Scale Weight (lbs)', {
              attr: { class: 'block text-sm font-medium text-gray-300 mb-2' }
            }) }}
            {{ form_widget(form.scaleWeight, {
              attr: {
                class: 'w-full px-3 py-3 bg-gray-700 text-white border border-gray-600 rounded-lg text-base focus:outline-none focus:border-sky-400',
                placeholder: 'Enter weight from scale',
                step: '0.1',
                id: 'form-scale-weight'
              }
            }) }}
            {{ form_errors(form.scaleWeight) }}
          </div>

          <!-- Hidden sensor fields - auto-filled via JS -->
          <div class="hidden">
            {{ form_row(form.airPressure, { attr: { id: 'form-air-pressure' } }) }}
            {{ form_row(form.ambientAirPressure, { attr: { id: 'form-ambient-pressure' } }) }}
            {{ form_row(form.airTemperature, { attr: { id: 'form-temperature' } }) }}
            {{ form_row(form.elevation, { attr: { id: 'form-elevation' } }) }}
          </div>

          <!-- Comment (Optional) -->
          <div>
            {{ form_label(form.comment, 'Comment (optional)', {
              attr: { class: 'block text-sm font-medium text-gray-300 mb-2' }
            }) }}
            {{ form_widget(form.comment, {
              attr: {
                class: 'w-full px-3 py-2 bg-gray-700 text-white border border-gray-600 rounded-lg text-sm focus:outline-none focus:border-sky-400',
                rows: 2,
                placeholder: 'Add any notes...'
              }
            }) }}
          </div>

          <button
            type="submit"
            class="w-full py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors"
          >
            ‚úì Add Calibration Point
          </button>
        {{ form_end(form) }}
      </section>

      <!-- Calibration Count -->
      <div class="mx-4 mb-4">
        <a
          href="{{ path('device_calibration_history', { id: device.id }) }}"
          class="block p-3 text-center text-sm bg-gray-800 border border-gray-700 rounded-lg text-sky-400 hover:text-sky-300 hover:border-sky-500 transition-colors"
        >
          View Calibration History ({{ calibrationCount }} points)
        </a>
      </div>
    </div>

    <!-- Channel 2 Content -->
    <div id="channel-2-content" class="channel-content hidden">

      <!-- Live Readings Card -->
      <section class="m-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Live Readings - Channel 2</h2>
          <button
            type="button"
            onclick="refreshData(2)"
            class="px-3 py-1 text-xs font-medium bg-sky-600 hover:bg-sky-700 rounded transition-colors"
          >
            üîÑ Refresh
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <div class="text-gray-400 text-xs mb-1">Air Pressure</div>
            <div id="ch2-air-pressure" class="font-semibold text-green-400">-- psi</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs mb-1">Weight (Calc)</div>
            <div id="ch2-weight" class="font-semibold text-yellow-400">-- lbs</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs mb-1">Ambient Pressure</div>
            <div id="ch2-ambient-pressure" class="font-semibold text-green-400">-- psi</div>
          </div>
          <div>
            <div class="text-gray-400 text-xs mb-1">Temperature</div>
            <div id="ch2-temperature" class="font-semibold text-green-400">--¬∞F</div>
          </div>
        </div>

        <div class="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
          Last updated: <span id="ch2-timestamp">--</span>
        </div>
      </section>

      <!-- Same form card for Channel 2 -->
      <section class="m-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
        <h2 class="text-lg font-semibold mb-3">Add Calibration Point</h2>
        <p class="text-sm text-gray-400 mb-4">Place a known weight on your scale, then enter it below.</p>
        <p class="text-sm text-gray-500">Form active for Channel 2 when this tab is selected.</p>
      </section>

      <!-- Calibration Count -->
      <div class="mx-4 mb-4">
        <a
          href="{{ path('device_calibration_history', { id: device.id }) }}"
          class="block p-3 text-center text-sm bg-gray-800 border border-gray-700 rounded-lg text-sky-400 hover:text-sky-300 hover:border-sky-500 transition-colors"
        >
          View Calibration History ({{ calibrationCount }} points)
        </a>
      </div>
    </div>

  </main>
</div>

<style>
.channel-tab {
  color: #9ca3af;
  border-color: transparent;
}
.channel-tab.active {
  color: #38bdf8;
  border-color: #38bdf8;
  background-color: rgba(56, 189, 248, 0.1);
}
</style>

<script>
let currentChannel = 1;
const deviceId = {{ device.id }};

// Initialize - set Channel 1 as active
document.addEventListener('DOMContentLoaded', function() {
  switchChannel(1);

  // Initial data load
  refreshData(1);
  refreshData(2);
});

function switchChannel(channelIndex) {
  currentChannel = channelIndex;

  // Update tabs
  document.querySelectorAll('.channel-tab').forEach(tab => {
    const tabChannel = parseInt(tab.dataset.channel);
    if (tabChannel === channelIndex) {
      tab.classList.add('active');
    } else {
      tab.classList.remove('active');
    }
  });

  // Update content visibility
  document.querySelectorAll('.channel-content').forEach(content => {
    content.classList.add('hidden');
  });
  document.getElementById(`channel-${channelIndex}-content`).classList.remove('hidden');

  // Update hidden form field for channel selection
  const channelSelect = document.getElementById('form-device-channel');
  if (channelSelect) {
    // Find the option that corresponds to this channel index
    Array.from(channelSelect.options).forEach(option => {
      const optionText = option.text.toLowerCase();
      if (optionText.includes(`channel ${channelIndex}`)) {
        channelSelect.value = option.value;
      }
    });
  }
}

function refreshData(channelIndex) {
  fetch(`/device/${deviceId}/api/live-data`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('API Error:', data.error);
        return;
      }

      // Update environmental data (shared)
      const ambientPressure = data.atmospheric_pressure || 0;
      const temperature = data.temperature || 0;
      const elevation = data.elevation || 0;

      // Update channel-specific data
      let airPressure = 0;
      let weight = 0;

      if (data.channels && data.channels.length > 0) {
        // Multi-channel format
        const channelData = data.channels.find(ch => ch.channel_index === channelIndex);
        if (channelData) {
          airPressure = channelData.air_pressure || 0;
          weight = channelData.weight || 0;
        }
      } else if (channelIndex === 1) {
        // Legacy single-channel format (only for Channel 1)
        airPressure = data.main_air_pressure || 0;
        weight = data.weight || 0;
      }

      // Update UI
      const prefix = `ch${channelIndex}`;
      document.getElementById(`${prefix}-air-pressure`).textContent = `${airPressure.toFixed(2)} psi`;
      document.getElementById(`${prefix}-weight`).textContent = `${Math.round(weight).toLocaleString()} lbs`;
      document.getElementById(`${prefix}-ambient-pressure`).textContent = `${ambientPressure.toFixed(2)} psi`;
      document.getElementById(`${prefix}-temperature`).textContent = `${Math.round(temperature)}¬∞F`;
      document.getElementById(`${prefix}-timestamp`).textContent = new Date(data.timestamp).toLocaleTimeString();

      // Auto-fill form if this is the active channel
      if (channelIndex === currentChannel) {
        document.getElementById('form-air-pressure').value = airPressure.toFixed(2);
        document.getElementById('form-ambient-pressure').value = ambientPressure.toFixed(2);
        document.getElementById('form-temperature').value = temperature.toFixed(2);
        document.getElementById('form-elevation').value = elevation.toFixed(2);
      }
    })
    .catch(err => {
      console.error('Refresh failed:', err);
    });
}

// Auto-refresh every 5 seconds for current channel
setInterval(() => {
  refreshData(currentChannel);
}, 5000);
</script>
{% endblock %}
