{# templates/configuration/edit.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Edit {{ configuration.name }}{% endblock %}

{% block body %}
<div class="min-h-screen text-white bg-gray-900">

  <!-- Header -->
  <header class="sticky top-0 z-50 px-4 py-3 bg-gray-800 border-b border-gray-700 shadow-md">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold text-white">Edit Configuration</h1>
        <div class="text-sm text-gray-400 mt-1">{{ configuration.name }}</div>
      </div>
      <a href="{{ path('configuration_show', {id: configuration.id}) }}" class="text-sm text-sky-400 hover:text-sky-300">
        ‚Üê Back
      </a>
    </div>
  </header>

  <main class="pb-20">

    <!-- Flash Messages -->
    {% for type, messages in app.flashes %}
      {% for message in messages %}
        <div class="mx-4 mt-4 p-3 rounded-lg border-l-4 {% if type == 'success' %}bg-green-900/50 border-green-500 text-green-100{% elseif type == 'warning' %}bg-yellow-900/50 border-yellow-500 text-yellow-100{% else %}bg-red-900/50 border-red-500 text-red-100{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endfor %}

    <!-- Basic Info -->
    <form method="POST" class="m-4">
      <section class="p-4 bg-gray-800 rounded-lg border border-gray-700">
        <h2 class="text-lg font-semibold mb-4">Basic Information</h2>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Configuration Name</label>
            <input type="text" name="name" value="{{ configuration.name }}" required
                   class="w-full px-3 py-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-sky-400">
          </div>

          <button type="submit"
                  class="w-full py-3 font-semibold bg-sky-600 hover:bg-sky-700 rounded-lg transition-colors">
            Save Changes
          </button>
        </div>
      </section>
    </form>

    <!-- Fleet Sharing -->
    <section class="m-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
      <h2 class="text-lg font-semibold mb-2">Fleet Sharing</h2>
      <p class="text-sm text-gray-400 mb-4">
        Share this configuration with all users in your fleet to avoid duplication
      </p>

      <div class="flex items-center justify-between p-4 bg-gray-750 border border-gray-600 rounded-lg">
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0">
            <i class="text-xl {% if configuration.isShared %}text-green-400 fas fa-users{% else %}text-gray-400 fas fa-lock{% endif %}"></i>
          </div>
          <div>
            <div class="font-medium text-white">
              {% if configuration.isShared %}
                Shared with Fleet
              {% else %}
                Private Configuration
              {% endif %}
            </div>
            <div class="text-xs text-gray-400">
              {% if configuration.isShared %}
                All users can view and activate this configuration
              {% else %}
                Only you can see this configuration
              {% endif %}
            </div>
          </div>
        </div>
        <button
          id="toggle-shared-btn"
          onclick="toggleShared()"
          class="px-4 py-2 text-sm font-semibold transition-colors rounded-lg {% if configuration.isShared %}bg-orange-600 hover:bg-orange-700{% else %}bg-green-600 hover:bg-green-700{% endif %}"
        >
          {% if configuration.isShared %}
            <i class="mr-1 fas fa-lock"></i> Make Private
          {% else %}
            <i class="mr-1 fas fa-share-alt"></i> Share
          {% endif %}
        </button>
      </div>
    </section>

    <!-- Current Devices -->
    <section class="m-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
      <h2 class="text-lg font-semibold mb-3">Devices in this Configuration</h2>

      {% if configuration.deviceRoles|length == 0 %}
        <div class="p-6 text-center text-gray-400">
          No devices assigned yet
        </div>
      {% else %}
        <div class="space-y-2">
          {% for deviceRole in sortedDeviceRoles %}
            {% set device = deviceRole.device %}
            <div class="p-3 {% if device.hasVirtualSteer %}bg-purple-900/10 border-purple-600{% else %}bg-gray-750 border-gray-600{% endif %} border rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <div class="font-medium">{{ device.serialNumber ?: 'AS25-' ~ device.id }}</div>
                  <div class="text-xs text-gray-400">{{ deviceRole.role }}</div>
                  {% if device.hasVirtualSteer %}
                    <div class="text-xs text-purple-400 mt-1"><i class="fas fa-calculator mr-1"></i>Virtual Steer Enabled</div>
                  {% endif %}
                </div>
                <div class="flex gap-2">
                  <button onclick="toggleDeviceSettings({{ device.id }})" class="px-3 py-1 text-sm bg-gray-600 hover:bg-gray-500 rounded">
                    <i class="fas fa-cog"></i>
                  </button>
                  <button onclick="removeDevice({{ deviceRole.id }})" class="px-3 py-1 text-sm bg-red-600 hover:bg-red-700 rounded">
                    Remove
                  </button>
                </div>
              </div>

              <!-- Device Settings Panel (collapsed by default) -->
              <div id="device-settings-{{ device.id }}" class="hidden mt-3 pt-3 border-t border-gray-500">
                <h4 class="text-sm font-semibold text-white mb-3">Virtual Steer Axle Settings</h4>

                <div class="space-y-3">
                  <div class="flex items-center gap-3">
                    <input type="checkbox" id="has_virtual_steer_{{ device.id }}" {{ device.hasVirtualSteer ? 'checked' : '' }}
                           onchange="toggleDeviceVirtualSteer({{ device.id }})"
                           class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-400">
                    <label for="has_virtual_steer_{{ device.id }}" class="text-sm text-gray-300">
                      Enable Virtual Steer for this device
                    </label>
                  </div>

                  <div id="virtual-steer-fields-{{ device.id }}" class="{{ device.hasVirtualSteer ? '' : 'hidden' }} space-y-3">
                    <div>
                      <label class="block text-xs font-medium text-gray-400 mb-1">
                        Wheelbase Length (inches)
                        <span class="text-gray-500">- Steer to drive axle center</span>
                      </label>
                      <input type="number" id="wheelbase_{{ device.id }}" value="{{ device.wheelbase }}" step="0.1"
                             placeholder="e.g., 244"
                             class="w-full px-3 py-2 text-sm bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-purple-400">
                    </div>

                    <div>
                      <label class="block text-xs font-medium text-gray-400 mb-1">
                        Kingpin Distance (inches) <span class="text-gray-500">- Optional, system will estimate</span>
                      </label>
                      <input type="number" id="kingpin_distance_{{ device.id }}" value="{{ device.kingpinDistance }}" step="0.1"
                             placeholder="Leave blank to auto-calculate"
                             class="w-full px-3 py-2 text-sm bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-purple-400">
                    </div>

                    <button onclick="saveDeviceVirtualSteer({{ device.id }})"
                            class="w-full py-2 text-sm font-semibold bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                      Save Virtual Steer Settings
                    </button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Add Device Form -->
      <div class="mt-4 pt-4 border-t border-gray-700">
        <h3 class="text-md font-semibold mb-3">Add Device</h3>
        {% if devices|length > 0 %}
          <div class="flex gap-2">
            <select id="device-select" class="flex-1 px-3 py-2 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-sky-400">
              <option value="">Select a device...</option>
              {% for device in devices %}
                <option value="{{ device.id }}">{{ device.serialNumber ?: 'AS25-' ~ device.id }}</option>
              {% endfor %}
            </select>
            <select id="role-select" class="px-3 py-2 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-sky-400">
              {% for axleGroup in axleGroups %}
                <option value="{{ axleGroup.name }}">{{ axleGroup.label ?: axleGroup.name }}</option>
              {% endfor %}
            </select>
            <button onclick="addDevice()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg">
              Add
            </button>
          </div>
        {% else %}
          <div class="text-sm text-gray-400">
            No devices available. Make sure you have devices registered.
          </div>
        {% endif %}
      </div>
    </section>

    <!-- Danger Zone -->
    <section class="m-4 p-4 bg-red-900/20 border border-red-700 rounded-lg">
      <h2 class="text-lg font-semibold text-red-400 mb-3">Danger Zone</h2>

      <button onclick="deleteConfiguration({{ configuration.id }})"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
        Delete Configuration
      </button>
      <div class="text-xs text-gray-400 mt-2">
        This will not delete your devices, only this grouping.
      </div>
    </section>

  </main>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800">
    <div class="flex items-center justify-around py-3">
      <!-- Devices -->
      <a href="{{ path('app_dashboard') }}" class="flex flex-col items-center px-3 py-2 space-y-1 hover:opacity-80 transition">
        <div class="flex items-center justify-center w-6 h-6 bg-gray-700 rounded-lg">
          <i class="text-sm text-gray-400 fas fa-tachometer-alt"></i>
        </div>
        <span class="text-xs text-gray-400">Devices</span>
      </a>

      <!-- Fleet -->
      <a href="{{ path('configuration_index') }}" class="flex flex-col items-center px-3 py-2 space-y-1 hover:opacity-80 transition">
        <div class="flex items-center justify-center w-6 h-6 bg-gray-700 rounded-lg">
          <i class="text-sm text-gray-400 fas fa-truck"></i>
        </div>
        <span class="text-xs text-gray-400">Fleet</span>
      </a>

      <!-- Calibrate -->
      <a href="{{ path('configuration_bulk_calibration', {id: configuration.id}) }}" class="flex flex-col items-center px-3 py-2 space-y-1 hover:opacity-80 transition">
        <div class="flex items-center justify-center w-6 h-6 bg-gray-700 rounded-lg">
          <i class="text-sm text-gray-400 fas fa-balance-scale"></i>
        </div>
        <span class="text-xs text-gray-400">Calibrate</span>
      </a>

      <!-- Profile -->
      <a href="{{ path('user_profile') }}" class="flex flex-col items-center px-3 py-2 space-y-1 hover:opacity-80 transition">
        <div class="flex items-center justify-center w-6 h-6 bg-gray-700 rounded-lg">
          <i class="text-sm text-gray-400 fas fa-user"></i>
        </div>
        <span class="text-xs text-gray-400">Profile</span>
      </a>
    </div>
  </nav>
</div>

<script>
function toggleDeviceSettings(deviceId) {
  const panel = document.getElementById(`device-settings-${deviceId}`);
  panel.classList.toggle('hidden');
}

function toggleDeviceVirtualSteer(deviceId) {
  const checkbox = document.getElementById(`has_virtual_steer_${deviceId}`);
  const fields = document.getElementById(`virtual-steer-fields-${deviceId}`);

  if (checkbox.checked) {
    fields.classList.remove('hidden');
  } else {
    fields.classList.add('hidden');
  }
}

function saveDeviceVirtualSteer(deviceId) {
  const hasVirtualSteer = document.getElementById(`has_virtual_steer_${deviceId}`).checked;
  const wheelbase = document.getElementById(`wheelbase_${deviceId}`).value;
  const kingpinDistance = document.getElementById(`kingpin_distance_${deviceId}`).value;

  const data = {
    has_virtual_steer: hasVirtualSteer ? '1' : '0',
    wheelbase: wheelbase || null,
    kingpin_distance: kingpinDistance || null
  };

  fetch(`/device/${deviceId}/update-virtual-steer`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Virtual Steer settings saved successfully!');
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(err => {
    alert('Failed to save settings');
    console.error(err);
  });
}

function toggleShared() {
  fetch('/configuration/{{ configuration.id }}/toggle-shared', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(err => {
    alert('Failed to update sharing status');
    console.error(err);
  });
}

function deleteConfiguration(configId) {
  if (confirm('Are you sure you want to delete this configuration? This cannot be undone.')) {
    fetch(`/configuration/${configId}/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = '{{ path('configuration_index') }}';
      } else {
        alert('Error: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => {
      alert('Failed to delete configuration');
      console.error(err);
    });
  }
}

function addDevice() {
  const deviceId = document.getElementById('device-select').value;
  const role = document.getElementById('role-select').value;

  if (!deviceId) {
    alert('Please select a device');
    return;
  }

  const formData = new FormData();
  formData.append('device_id', deviceId);
  formData.append('role', role);

  fetch(`/configuration/{{ configuration.id }}/add-device`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(err => {
    alert('Failed to add device');
    console.error(err);
  });
}

function removeDevice(deviceRoleId) {
  if (confirm('Remove this device from the configuration?')) {
    fetch(`/configuration/{{ configuration.id }}/remove-device/${deviceRoleId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.reload();
      } else {
        alert('Error: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => {
      alert('Failed to remove device');
      console.error(err);
    });
  }
}
</script>
{% endblock %}
